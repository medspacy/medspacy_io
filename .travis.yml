language: python
notifications:
  email: false
os:
  - linux
env:
  global:
    - PROJECT_NAME=medspacy_io
    - PYPI_REPO_NAME=medspacy-io
    - PYPI_LOGIN=__token__
    - PY35="cp35-cp35m"
    - PY36="cp36-cp36m"
    - PY37="cp37-cp37m"
    - PY38="cp38-cp38"
    - TRAVIS_PY36=3.6.7
    - TRAVIS_PY37=3.7
    - DEPLOY_TEST=true
    - secure: Jmt9G6ySp+DZAy0mIkYiw5pruDRlUKOM7IALaCjL784cPNpp+9tQade0qoR2F15ZNDzbaAvvRRMI/dD2COiem9jSVN6cQLP+7m3xnx/TS7aGlOASNOqAD9ztbXju3LOfs6QjJJjRVrhzfqKDOF6sNghyX6WErecBy1E53dl91W/RK+BlqmE+751ad47Jh+/8mjK+3nwwdcCYvq+ql8ozrklAmr29Y1ibTsin8B8AQRtaihgmDJlliU989TnH7vWxygE729Bm5VEwY+3GJE0CBsjrQWUiRumBC5liY5tO8v4950pwP8/9cgT8YWBTqGr5Y8L7n772Yss7zt3yBJ9L+9SfWfGcWackZdB1nzUidHt3FkagtJ6ROP5v9yrq8PP4xS8/DPQGKH3EElUMNDCmJ7E1cFx4v73/VdhfExNkhjQnpoLy0jGL4zuEZ0zG3yADRPuMl7l5J+fcfRghP3atDcvD/enmo9kovpu1bAC91MaEHMuKQB3yO/eLtx8sTH2XD9WS9kRN9KdV4b0D6QGbE30JPbwxJspES5fm71HcTz7yD7/WLFSW1pPYJLPoiVpQlsKcZKe2AbnNrLeXBNNOxHR1KQmekowfFu19ylser3B5WDZKNBT5XlrZZg9JzcdMngcuvla0Zjl/youM4+8UUliJQr0K2htUpTI+eXPnv9E=


# encrypt PYPI_PWD
matrix:
  include:
    - sudo: required
      services:
        - docker
      env: DOCKER_IMAGE=quay.io/pypa/manylinux1_x86_64
        PLAT=manylinux1_x86_64
#      drop i686,because SpaCy doesn't support it
#    - sudo: required
#      services:
#        - docker
#      env: DOCKER_IMAGE=quay.io/pypa/manylinux1_i686
#        PRE_CMD=linux32
#        PLAT=manylinux1_i686
    - sudo: required
      services:
        - docker
      env: DOCKER_IMAGE=quay.io/pypa/manylinux2010_x86_64
        PLAT=manylinux2010_x86_64

install:
  - /opt/python/${TRAVIS_PY36}/bin/pip install twine
  - /opt/python/${TRAVIS_PY36}/bin/pip install -r dev-requirements.txt
  - docker pull $DOCKER_IMAGE

script:
  - chmod 775 travis/build-wheels.sh
  - docker run --name "aaa36" -v `pwd`:/io $DOCKER_IMAGE $PRE_CMD /bin/sh -c "/io/travis/build-wheels.sh ${PLAT} ${PROJECT_NAME} ${PY36}"
#  - docker run --name "aaa37" -v `pwd`:/io $DOCKER_IMAGE $PRE_CMD /bin/sh -c "/io/travis/build-wheels.sh ${PLAT} ${PROJECT_NAME} ${PY37}"
#  - docker run --name "aaa38" -v `pwd`:/io $DOCKER_IMAGE $PRE_CMD /bin/sh -c "/io/travis/build-wheels.sh ${PLAT} ${PROJECT_NAME} ${PY38}"



deploy:
  # deploy develop to pypi.org
  - provider: script
    script: echo "deploying..." && ls wheelhouse && /opt/python/${TRAVIS_PY36}/bin/python -m twine upload -u ${PYPI_LOGIN} -p ${TWINE_PASSWORD} --skip-existing wheelhouse/*
    on:
      tags: true
      condition: "$DEPLOY_TEST == false"

#  - provider: pypi
#    user: "__token__"
#    server: https://test.pypi.org/legacy/
#    password:
#      secure: "mggGGk6YwHNdswBSPiD0av/ZqC4/FEm3YQYN5ApNrTfn9MkKh28WEvSCl7KO9HxtW6rW8jZuZBa3FynG6xLYZ6ZJepMtpgQkkvpGr25ZC0d7UapF5Eh5mH/qMbgysBmc3AEXF3Y/NWZTdgyAg1khsp3mwUhXUu5YVS0Wx6Z2idb+L7MiAbV1WO7wSzTNf8pGZ2iw9JOqOAjkOseVBW0fdGR8p1ObFO9VTTJYD3aPyVfxdswG9UjIMS+3QamGiy6FK7FJrd1y0zKLxOSZ1R+D3lhsAChOz56Wcdzp2ynEUwtvlQlgNM/DK4a2wTkKimtAvYjqVyP0hXJ3X1kiaUafWB74ANicS5yRaTZpowERQlZywQqVFZy4d5+EZIt+Omvc235RQt3ychgHyza1oPlgcmxTbF5LDgfHDg0OY890CVfVxtJorIYRynR60A0RRjM5COFP536X78tGClHZlSCiNueZo6JEGfba+ckIpRsGhhnVxIpo+nKBqGLnNul1i1AGJgi9Ype9+iRnRYxLsXVggVAiRitwDh3R7qte1Qfr4OyPu9fRqPGXioF+0rpUw4Gqb5PGL1aBy1lw9KrHazKdRkuhHiSnw88V8rql7Q/dfyURUP1csCqfiVdVIeUp1wj0y901N4+WpTgJE4FZK/ZnLmNSmvpz7GPI7yserAiDX5o="
#    skip_cleanup: true
#    skip_existing: true
#    verbose: true
#    on:
#      tags: false
#      condition: "$DEPLOY_TEST == true"

  # deploy develop to test.pypi.org
  - provider: script
    script: echo "deploying..." && ls dist && /opt/python/${TRAVIS_PY36}/bin/python -m twine upload --skip-existing --verobse --repository-url https://test.pypi.org/legacy/ -u ${PYPI_LOGIN} -p ${TWINE_PASSWORD} dist dist/*
    skip_cleanup: true
    on:
      tags: false
      condition: "$DEPLOY_TEST == true"

